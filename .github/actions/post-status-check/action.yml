name: Post status check
description: Post pending or outcome status check for workflow_dispatch events

inputs:
  state:
    description: Status state (pending, success, failure)
    required: true
  context:
    description: Status context name
    required: true
  job-status:
    description: Job status (for outcome checks)
    required: true
  workflow-file:
    description: Workflow file name to use in the status description (e.g. ci.yml)
    required: true

runs:
  using: composite
  steps:
    - name: Post pending status
      if: ${{ inputs.state == 'pending' && github.event_name == 'workflow_dispatch' }}
      shell: bash
      env:
        GH_TOKEN: ${{ github.token }}
        CONTEXT: ${{ inputs.context }}
        WORKFLOW_FILE: ${{ inputs.workflow-file }}
        EVENT_NAME: ${{ github.event_name }}
      run: |
        sha=$(git rev-parse HEAD)
        gh api "repos/${GITHUB_REPOSITORY}/statuses/${sha}" \
          -f state="pending" \
          -f context="${CONTEXT}" \
          -f description="${WORKFLOW_FILE} (${EVENT_NAME}) in progress" \
          -f target_url="https://github.com/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"

    - name: Post outcome status
      if: ${{ inputs.state == 'outcome' && github.event_name == 'workflow_dispatch' }}
      shell: bash
      env:
        GH_TOKEN: ${{ github.token }}
        JOB_STATUS: ${{ inputs.job-status }}
        CONTEXT: ${{ inputs.context }}
        WORKFLOW_FILE: ${{ inputs.workflow-file }}
        EVENT_NAME: ${{ github.event_name }}
      run: |
        sha=$(git rev-parse HEAD)
        if [ "$JOB_STATUS" = "success" ]; then
          state="success"
          description="${WORKFLOW_FILE} (${EVENT_NAME}) succeeded"
        else
          state="failure"
          description="${WORKFLOW_FILE} (${EVENT_NAME}) failed"
        fi

        gh api "repos/${GITHUB_REPOSITORY}/statuses/${sha}" \
          -f state="$state" \
          -f context="${CONTEXT}" \
          -f description="$description" \
          -f target_url="https://github.com/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"

        if [ "$JOB_STATUS" != "success" ]; then
          exit 1
        fi
