name: Checkout and set Nx SHAs
description: Checkout repository with Nx-optimized settings and derive appropriate SHAs for nx affected commands

inputs:
  ref:
    description: Git ref to checkout
    required: false
    default: ''

runs:
  using: composite
  steps:
    - name: Determine checkout ref
      id: checkout-ref
      shell: bash
      env:
        INPUT_REF: ${{ inputs.ref }}
        DEFAULT_REF: ${{ github.ref }}
      run: |
        if [ -n "${INPUT_REF}" ]; then
          echo "ref=${INPUT_REF}" >> "$GITHUB_OUTPUT"
        else
          echo "ref=${DEFAULT_REF}" >> "$GITHUB_OUTPUT"
        fi

    - uses: actions/checkout@v5
      with:
        # We need to fetch all branches and commits so that Nx affected has a base to compare against.
        fetch-depth: 0
        filter: tree:0 # Optional, but recommended: reduce the size of the checkout with tree filtering, see https://github.blog/open-source/git/get-up-to-speed-with-partial-clone-and-shallow-clone/
        ref: ${{ steps.checkout-ref.outputs.ref }}

    - name: Derive appropriate SHAs for base and head for `nx affected` commands
      uses: nrwl/nx-set-shas@v4
